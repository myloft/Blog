<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>iptables解决运营商DNS抢答(我劫持我自己) · ILOFT · 我的阁楼</title><meta name="description" content="iptables解决运营商DNS抢答(我劫持我自己) - Solyn"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://www.iloft.xyz/atom.xml" title="ILOFT · 我的阁楼"><meta name="generator" content="Hexo 5.3.0"><link rel="alternate" href="/atom.xml" title="ILOFT · 我的阁楼" type="application/atom+xml">
</head><body><div class="wrap"><header><a class="logo-link" href="/"><img src="/logo.svg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">LOFT</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self">ARCHIVE</a></li><li class="nav-list-item"><a class="nav-list-link" href="/about/" target="_self">ABOUT</a></li><li class="nav-list-item"><a class="nav-list-link" href="/links/" target="_self">LINKS</a></li><li class="nav-list-item"><a class="nav-list-link" href="/atom.xml" target="_self">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">iptables解决运营商DNS抢答(我劫持我自己)</h1><div class="post-info">2019年1月23日</div><div class="post-content"><p>　　春节带着NAS回家，发现UT里的种子一片红。本以为是CloudFlare连通性不好，但PT主站都能正常访问。尝试ping发现tracker服务器被解析到了127.0.0.1。</p><a id="more"></a><h2 id="检测"><a href="#检测" class="headerlink" title="检测"></a>检测</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">//</span>响应<span class="number">127.0</span>.<span class="number">0.1</span>确认DNS被劫持。</span><br><span class="line">nslookup whether.<span class="number">114</span>dns.com <span class="number">114.114</span>.<span class="number">114.114</span></span><br></pre></td></tr></table></figure><p>　　确认到dns被劫持，接下来就需要找到抢答的服务器IP。直接从<a target="_blank" rel="noopener" href="http://nstool.netease.com/">网易DNS检测工具</a>看到目前使用的DNS服务器是运营商提供的153.3.231.218。（不排除某些情况下需要抓包)</p><h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p><del>直接在openwrt防火墙自定义规则里将该ip段的流量全部drop掉。</del></p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -I <span class="keyword">INPUT</span> -s 153.3.231.0/16 -j <span class="keyword">DROP</span> <span class="comment">//请无视</span></span><br></pre></td></tr></table></figure><h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">//</span>响应<span class="number">58.217</span>.<span class="number">249.139</span>确认成功使用<span class="number">114</span>dns解析。</span><br><span class="line">nslookup whether.<span class="number">114</span>dns.com <span class="number">114.114</span>.<span class="number">114.114</span></span><br></pre></td></tr></table></figure><p>　　更新一下tracker红种全部变蓝，可以继续愉快做种了~~~</p><h2 id="打脸"><a href="#打脸" class="headerlink" title="打脸"></a>打脸</h2><p>　　早上尝试抓包，然后再水一篇<strong>wireshark抓包定位DNS抢答服务器</strong>。然而并没有出现抢答现象，响应ip就是查询的NS服务器，说明昨天一顿操作……<br><img src="/images/fake-dns-response.jpg" alt="伪造的dns响应"><br>　　仔细看了下iptables发现….是我劫持了我自己</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">iptables</span> -t nat -A PREROUTING -p udp --dport <span class="number">53</span> -j REDIRECT --to-ports <span class="number">53</span></span><br><span class="line"><span class="attribute">iptables</span> -t nat -A PREROUTING -p tcp --dport <span class="number">53</span> -j REDIRECT --to-ports <span class="number">53</span></span><br></pre></td></tr></table></figure><p>　　所有的dns查询都被转发给了路由器，路由器从运营商dns拿到解析，然后还贴心的伪造了响应。我的天（说明网上的固件不要乱刷…鬼知道里面还塞了什么）！<br>　　删掉这条之后，dns解析就正常了。<br><img src="/images/real-dns-response.jpg" alt="伪造的dns响应"><br>　　天知道我昨天是怎么解析出来正确ip的，给联通道个歉~</p></div></article></div></main><footer><div class="paginator"><a class="prev" href="/archives/v2ray-h2-web.html">上一篇</a><a class="next" href="/archives/tensorflow-whitepaper-zh-pdf.html">下一篇</a></div><a id="comments"></a><div id="vcomments" style="margin:0 30px"></div><script src="//cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var valine=new Valine({el:"#vcomments",notify:!1,verify:!1,app_id:"N1tTKn3LEO1Xmg4kMyX8TDy6-gzGzoHsz",app_key:"i4xk0BbhpGn2n9OlAelavNx9",placeholder:"",path:window.location.pathname,avatar:"retro",avatar_cdn:"https://sdn.geekzu.org/avatar/",serverURLs:"https://api.iloft.xyz"})</script><div class="copyright"><p>© 2013 - 2021 <a href="https://www.iloft.xyz">Solyn</a>, Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> <a href="/sitemap.xml" target="_blank">Sitemap</a></p><p><a href="https://beian.miit.gov.cn/" target="_blank">苏ICP备16033901号-3</a></p></div></footer></div><script>!function(e,a,t,n,g,c){e.GoogleAnalyticsObject=n,e.ga||(e.ga=function(){(e.ga.q=e.ga.q||[]).push(arguments)}),e.ga.l=+new Date,g=a.createElement(t),c=a.getElementsByTagName(t)[0],g.src="//www.google-analytics.com/analytics.js",c.parentNode.insertBefore(g,c)}(window,document,"script","ga"),ga("create","UA-89639365-1","auto"),ga("send","pageview")</script></body></html>